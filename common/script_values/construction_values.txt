calculate_limited_construction_demand = {
	value = local_var:nominal_construction_demand
	#set maximum usage to just over double the supply
	max = {
		value = local_var:national_production
		multiply = 2
		multiply = 1.05
		divide = 10
		min = 10
	}
}

#Calculate construction while ignoring supply limit
calculate_nominal_construction = {
	if = {
		limit = {
			has_law = law_type:law_command_economy
		}
		value = income
		multiply = 1.5 #allow more spending than income, but not too much. TODO: test and choose a better value
	}
	else = {
		value = investment_pool_gross_income
		add = local_var:max_government_construction_spending
	}
	divide = construction_point_price
}

#price of each construction point is 10 goods
construction_point_price = {
	value = construction_good_price
	multiply = 10
}

construction_good_price = {
	value = 95 #base price of construction good
	if = {
		#make sure that construction has been calculated once before to avoid assuming construction cost is -75%
		limit = {
			game_date > 1836.1.5
		}
		multiply = {
			value = 1
			add = construction_price_multiplier
		}
	}
}

#calculate estimated national construction price multiplier based on formula: https://vic3.paradoxwikis.com/Market#Market_price
construction_price_multiplier = {
	value = 0.75
	multiply = {
		value = {
			value = local_var:national_consumption
			subtract = local_var:national_production
			divide = {
				value = local_var:national_consumption
				max = local_var:national_production
				min = 1
			}
		}
		#clamp between 1 and -1
		max = 1
		min = -1
	}
}

national_construction_production = {
	every_scope_state = {
		sg:construction = {
			add = state_goods_production 
		}
	}
}

national_construction_consumption = {
	every_scope_state = {
		sg:construction = {
			add = state_goods_consumption 
		}
	}
}

state_construction_allocation = {
	value = local_var:limited_construction_demand
	owner = {
		divide = {
			value = local_var:national_production
			divide = 10
			min = 0.1
		}
	}
	max = 2.05 # demand only a limited amount more than is possible in this state

	if = {
		limit = {
			sg:construction = {
				state_goods_production = 0
			}
		}
		value = local_var:remaining_construction_demand
		multiply = 0.5
	}
	else = {
		sg:construction = {
			multiply = state_goods_production
			divide = 10
		}
	}
	min = 3
	max = local_var:remaining_construction_demand
}
construction_ordering = {
	sg:construction = {
		value = state_goods_production
		multiply = 100
	}
	add = {
		value = gdp
		owner = {
			divide = gdp
		}
	}
}

calculate_government_construction_spending = {
	value = 1
	subtract = modifier:country_private_construction_allocation_mult
	multiply = investment_pool_gross_income
	multiply = var:construction_spending_level
}

calculate_current_government_construction_spending = {
	value = local_var:max_government_construction_spending
	multiply = {
		value = local_var:limited_construction_demand
		if = {
			limit = {
				local_var:nominal_construction_demand != 0
			}
			divide = local_var:nominal_construction_demand
		}
	}
	save_temporary_value_as = limited_spending_value
	divide = construction_good_price
	save_temporary_value_as = max_points
	value = construction_queue_num_queued_government_levels
	multiply = modifier:country_max_weekly_construction_progress_add
	if = {
		limit = {
			scope:max_points != 0
		}
		divide = scope:max_points
	}
	max = 1
	multiply = scope:limited_spending_value
}
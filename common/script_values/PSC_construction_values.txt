calculate_limited_construction_demand = {
	value = var:nominal_construction_demand
	#set maximum usage to just over double the supply
	max = {
		value = var:national_production
		multiply = define:NEconomy|BUY_SELL_DIFF_AT_MAX_FACTOR
		multiply = oversupply_limit
		divide = 10
		min = 10
	}
}

#Calculate construction while ignoring supply limit
calculate_nominal_construction = {
	if = {
		limit = {
			has_law = law_type:law_command_economy
		}
		value = weekly_net_fixed_income
		multiply = var:construction_spending_level
	}
	else = {
		value = investment_pool_gross_income
		multiply = {
			value = 1
			subtract = var:privatisation_percent_estimate
		}
		add = var:limited_government_construction_spending
	}
	divide = {
		value = var:construction_price_estimate
		min = 1
	}
}

construction_price_average = {
	value = var:construction_price_estimate
	multiply = {
		value = construction_price_weeks
		subtract = 1
	}
	divide = construction_price_weeks
	add = {
		value = construction_point_price_weekly
		divide = construction_price_weeks
	}
}

construction_point_price_weekly = {
	if = {	
		limit = {
			national_construction_consumption > 0
		}
		value = var:total_construction_spending
		divide = national_construction_consumption
	}
	else = {
		value = construction_good_adjustable_base_price
	}
	multiply = 10
}

construction_good_adjustable_base_price = {
	if = {
		limit = {
			owner = {
				has_technology_researched = arc_welding
			}
		}
		value = arc_welded_construction_good_base_price
	}
	else_if = {
		limit = {
			owner = {
				has_technology_researched = steel_frame_buildings
			}
        }
		value = steel_construction_good_base_price
	}
	else_if = {
		limit = {
			owner = {
				has_technology_researched = urban_planning
			}
		}
		value = iron_construction_good_base_price
	}
	else = {
		value = wood_construction_good_base_price
	}
}

privatisation_spending_percent = {
	value = var:privatisation_percent_estimate
	multiply = {
		value = privatisation_percent_weeks
		subtract = 1
	}
	divide = privatisation_percent_weeks
	add = {
		value = privatisation_spending_percent_weekly
		divide = privatisation_percent_weeks
	}
}

privatisation_spending_percent_weekly = {
	if = {
		limit = {
			var:prev_estimated_investment_pool = 0
		}
		value = 0
	}
	else = {
		value = 1
		subtract = {
			value = investment_pool
			divide = {
				value = var:prev_estimated_investment_pool
				min = 1
			}
		}
		min = 0
		max = 1
	}
}

national_construction_production = {
	every_scope_state = {
		add = sum_construction_types_production
	}
}

national_construction_consumption = {
	every_scope_state = {
		add = sum_construction_types_consumption
	}
}

state_construction_allocation = {
	owner = {
		value = var:limited_construction_demand
	}
	owner = {
		divide = {
			value = var:national_production
			divide = 10
			min = 0.1
		}
	}
	# demand only a limited amount more than is possible in this state
	max = {
		value = define:NEconomy|BUY_SELL_DIFF_AT_MAX_FACTOR
		multiply = state_oversupply_limit
	}

	if = {
		#in a case of no production, demand half the remaining demand to get construction to build
		limit = {
			sum_construction_types_production = 0
		}
		value = local_var:remaining_construction_demand
		multiply = 0.5
		min = 10
		max = local_var:remaining_construction_demand
	}
	else = {
		multiply = sum_construction_types_production
		divide = 10
	}
}

construction_ordering = {
	value = sum_construction_types_production
	multiply = 100
	add = {
		value = gdp
		owner = {
			divide = {
				value = gdp
				min = 1
			}
		}
	}
}

#Scope: State
sum_construction_types_production = {
	sg:wood_construction = {
		value = state_goods_production
	}
	sg:iron_construction = {
		add = state_goods_production
	}
	sg:steel_construction = {
		add = state_goods_production
	}
	sg:arc_welded_construction = {
		add = state_goods_production
	}
}

#Scope: State
sum_construction_types_consumption = {
	sg:wood_construction = {
		value = state_goods_consumption
	}
	sg:iron_construction = {
		add = state_goods_consumption
	}
	sg:steel_construction = {
		add = state_goods_consumption
	}
	sg:arc_welded_construction = {
		add = state_goods_consumption
	}
}

calculate_limited_government_construction_spending = {
	value = 1
	subtract = modifier:country_private_construction_allocation_mult
	divide = modifier:country_private_construction_allocation_mult
	multiply = investment_pool_gross_income
	if = {
		limit = {
			OR = {
				is_construction_paused = yes
				construction_queue_num_queued_government_levels = 0 
			}
		}
		value = 0
	}
}

max_government_construction_spending = {
	value = 1
	subtract = corrected_private_allocation
	divide = corrected_private_allocation
	multiply = investment_pool_gross_income
}

calculate_total_construction_spending = {
	value = 0
	every_scope_state = {
		sg:wood_construction = {
			add = {
				value = state_goods_consumption
				multiply = wood_construction_good_base_price
				multiply = {
					value = 1
					add = state_goods_pricier
				}
			}
		}
		sg:iron_construction = {
			add = {
				value = state_goods_consumption
				multiply = iron_construction_good_base_price
				multiply = {
					value = 1
					add = state_goods_pricier
				}
			}
		}
		sg:steel_construction = {
			add = {
				value = state_goods_consumption
				multiply = steel_construction_good_base_price
				multiply = {
					value = 1
					add = state_goods_pricier
				}
			}
		}
		sg:arc_welded_construction = {
			add = {
				value = state_goods_consumption
				multiply = arc_welded_construction_good_base_price
				multiply = {
					value = 1
					add = state_goods_pricier
				}
			}
		}
	}
}

calculate_government_construction_spending = {
	value = var:total_construction_spending
	#subtract private spending
	subtract = {
		value = investment_pool_gross_income
		subtract = investment_pool_net_income
	}
	max = var:limited_government_construction_spending
	min = 0
}


private_construction_increase = {
	value = corrected_private_allocation
	divide = {
		value = corrected_private_allocation
		add = {
			value = 1
			subtract = corrected_private_allocation
			multiply = var:construction_spending_level
		}
	}
	subtract = corrected_private_allocation
}

corrected_private_allocation = {

	value = modifier:country_private_construction_allocation_mult
	if = {
		limit = {
			has_variable = prev_construction_allocation
		}
		subtract = var:prev_construction_allocation
	}
}

ai_construction_demand = {
	add = {
		value = weekly_net_fixed_income
		divide = var:construction_price_estimate

		min = {
			value = income
			subtract = {
				value = investment_pool_gross_income
				subtract = investment_pool_net_income
			}
			divide = 7500 # 1 construction output per this much income
			# Improved technology enables cheaper construction
			
			# Based on a construction sector weekly balance of 1000
			# Cost per wood construction 3000/2 = 1500
			# Cost per iron construction 4600/5 = 950
			# Cost per steel construction 5400/10 = 640

			if = {
				limit = { has_technology_researched = urban_planning }
				multiply = 1.63
			}

			if = {
				limit = { has_technology_researched = steel_frame_buildings }
				multiply = 1.44
			}
		}
	}
}

construction_demand_ratio = {
	value = var:nominal_construction_demand
	multiply = 10
	divide = {
		value = var:national_production
		min = 0.1
	}
}

construction_regulator_level = {
	if = {
		limit = {
			has_building = building_construction_sector
		}
		b:building_construction_sector = {
			value = level
		}
	}
	min = 1
}

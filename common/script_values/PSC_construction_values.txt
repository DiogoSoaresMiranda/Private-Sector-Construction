calculate_limited_construction_demand = {
	value = var:nominal_construction_demand
	#set maximum usage to just over double the supply
	max = {
		value = var:national_production
		multiply = define:NEconomy|BUY_SELL_DIFF_AT_MAX_FACTOR
		multiply = oversupply_limit
		divide = 10
		min = 10
	}
}

#Calculate construction while ignoring supply limit
calculate_nominal_construction = {
	if = {
		limit = {
			has_law = law_type:law_command_economy
		}
		value = weekly_net_fixed_income
		multiply = var:construction_spending_level
	}
	else = {
		value = investment_pool_gross_income
		multiply = {
			value = 1
			subtract = var:privatisation_percent_estimate
		}
		add = var:limited_government_construction_spending
	}
	divide = var:construction_price_estimate
}

construction_price_average = {
	value = var:construction_price_estimate
	multiply = {
		value = construction_price_weeks
		subtract = 1
	}
	divide = construction_price_weeks
	add = {
		value = construction_point_price_weekly
		divide = construction_price_weeks
	}
}

#price of each construction point is 10 goods
construction_point_price_weekly = {
	value = construction_good_price_weekly
	multiply = 10
}

construction_good_price_weekly = {
	value = construction_good_base_price
	if = {
		#make sure that construction has been calculated once before to avoid assuming construction cost is -75%
		limit = {
			game_date > 1836.1.5
		}
		multiply = {
			value = 1
			add = construction_price_multiplier
		}
	}
}

#calculate estimated national construction price multiplier based on formula: https://vic3.paradoxwikis.com/Market#Market_price
construction_price_multiplier = {
	value = define:NEconomy|PRICE_RANGE
	multiply = {
		value = {
			value = var:national_consumption
			subtract = var:national_production
			divide = {
				value = var:national_consumption
				max = var:national_production
				min = 1
			}
			multiply = {
				value = 1
				divide = {
					value = define:NEconomy|BUY_SELL_DIFF_AT_MAX_FACTOR
					subtract = 1
				}
			}
		}
		#clamp between 1 and -1
		max = 1
		min = -1
	}
}

privatisation_spending_percent = {
	value = var:privatisation_percent_estimate
	multiply = {
		value = privatisation_percent_weeks
		subtract = 1
	}
	divide = privatisation_percent_weeks
	add = {
		value = privatisation_spending_percent_weekly
		divide = privatisation_percent_weeks
	}
}

privatisation_spending_percent_weekly = {
	if = {
		limit = {
			var:prev_estimated_investment_pool = 0
		}
		value = 0
	}
	else = {
		value = 1
		subtract = {
			value = investment_pool
			divide = var:prev_estimated_investment_pool
		}
		min = 0
		max = 1
	}
}

construction_state_price_multiplier = {
	value = define:NEconomy|PRICE_RANGE
	multiply = {
		value = {
			value = var:national_consumption
			subtract = var:national_production
			divide = {
				value = var:national_consumption
				max = var:national_production
				min = 1
			}
		}
		#clamp between 1 and -1
		max = 1
		min = -1
	}
}

national_construction_production = {
	every_scope_state = {
		sg:construction = {
			add = state_goods_production 
		}
	}
}

national_construction_consumption = {
	every_scope_state = {
		sg:construction = {
			add = state_goods_consumption 
		}
	}
}

state_construction_allocation = {
	owner = {
		value = var:limited_construction_demand
	}
	owner = {
		divide = {
			value = var:national_production
			divide = 10
			min = 0.1
		}
	}
	# demand only a limited amount more than is possible in this state
	max = {
		value = define:NEconomy|BUY_SELL_DIFF_AT_MAX_FACTOR
		multiply = state_oversupply_limit
	}

	if = {
		#in a case of no production, demand half the remaining demand to get construction to build
		limit = {
			sg:construction = {
				state_goods_production = 0
			}
		}
		value = local_var:remaining_construction_demand
		multiply = 0.5
	}
	else = {
		sg:construction = {
			multiply = state_goods_production
			divide = 10
		}
	}
	min = 10
	max = local_var:remaining_construction_demand
}

construction_ordering = {
	sg:construction = {
		value = state_goods_production
		multiply = 100
	}
	add = {
		value = gdp
		owner = {
			divide = gdp
		}
	}
}

calculate_limited_government_construction_spending = {
	value = 1
	subtract = modifier:country_private_construction_allocation_mult
	divide = modifier:country_private_construction_allocation_mult
	multiply = investment_pool_gross_income
	if = {
		limit = {
			OR = {
				is_construction_paused = yes
				construction_queue_num_queued_government_levels = 0 
			}
		}
		value = 0
	}
}

max_government_construction_spending = {
	value = 1
	subtract = corrected_private_allocation
	divide = corrected_private_allocation
	multiply = investment_pool_gross_income
}

calculate_total_construction_spending = {
	value = 0
	every_scope_state = {
		sg:construction = {
			add = {
				value = state_goods_consumption
				multiply = construction_good_base_price
				multiply = {
					value = 1
					add = state_goods_pricier
				}
			}
		}
	}
}

calculate_government_construction_spending = {
	value = calculate_total_construction_spending
	#subtract private spending
	subtract = {
		value = investment_pool_gross_income
		subtract = investment_pool_net_income
	}
	max = var:limited_government_construction_spending
	min = 0
}


private_construction_increase = {
	value = corrected_private_allocation
	divide = {
		value = corrected_private_allocation
		add = {
			value = 1
			subtract = corrected_private_allocation
			multiply = var:construction_spending_level
		}
	}
	subtract = corrected_private_allocation
}

corrected_private_allocation = {

	value = modifier:country_private_construction_allocation_mult
	if = {
		limit = {
			has_variable = prev_construction_allocation
		}
		subtract = var:prev_construction_allocation
	}
}

ai_construction_demand = {
	add = {
		value = weekly_net_fixed_income
		divide = 1500 #price of wooden construction

		min = {
			value = income
			subtract = {
				value = investment_pool_gross_income
				subtract = investment_pool_net_income
			}
			divide = 7500 # 1 construction output per this much income
		}
	}
	# Improved technology enables cheaper construction
	# Based on a construction sector weekly balance of 1000
	# Cost per wood construction 3000/2 = 1500
	# Cost per iron construction 4600/5 = 950
	# Cost per steel construction 5400/10 = 640

	if = {
		limit = { has_technology_researched = urban_planning }
		multiply = 1.63
	}

	if = {
		limit = { has_technology_researched = steel_frame_buildings }
		multiply = 1.44
	}
}

construction_demand_ratio = {
	value = var:nominal_construction_demand
	multiply = 10
	divide = {
		value = var:national_production
		min = 0.1
	}
}
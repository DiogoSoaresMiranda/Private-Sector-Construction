check_construction_spending_level = {
    if = {
        limit = {
            is_player = yes
        }
        if = {
            limit = {
                NOT = {
                    has_variable = construction_spending_level
                }
            }
            set_variable = {
                name = construction_spending_level
                value = 0.4
            }
        }
    }
    else = {
        set_variable = {
            name = construction_spending_level
            value = {
                if = {
                    limit = {
                        OR = {
                            is_construction_paused = yes
                            construction_queue_num_queued_government_levels = 0 
                        }
                    }
                    value = 0
                } else = {
                    value = ai_construction_demand
                    divide = {
                        value = max_government_construction_spending
                        divide = {
                            value = var:construction_price_estimate
                            min = 1
                        }
                        min = 0.1
                    }
                    min = 0
                    max = 1
                }
            }
        }
    }
}

change_point_converter_production_method = {
    if = {
        limit = {
            sg:wood_construction = {
                state_goods_production > 0
            }
        }
        if = {
            limit = {
                NOT = {
                    b:building_construction_regulator = {
                        has_active_production_method = pm_wood_point_conversion
                    }
                }
            }
            activate_production_method = {
                building_type = building_construction_regulator
                production_method = pm_wood_point_conversion
            }
        }
    }
    else_if = {
        limit = {
            sg:iron_construction = {
                state_goods_production > 0
            }
        }
        if = {
            limit = {
                NOT = {
                    b:building_construction_regulator = {
                        has_active_production_method = pm_iron_point_conversion
                    }
                }
            }
            activate_production_method = {
                building_type = building_construction_regulator
                production_method = pm_iron_point_conversion
            }
        }
    }
    else_if = {
        limit = {
            sg:steel_construction = {
                state_goods_production > 0
            }
        }
        if = {
            limit = {
                NOT = {
                    b:building_construction_regulator = {
                        has_active_production_method = pm_steel_point_conversion
                    }
                }
            }
            activate_production_method = {
                building_type = building_construction_regulator
                production_method = pm_steel_point_conversion
            }
        }
    }
    else_if = {
        limit = {
            sg:arc_welded_construction = {
                state_goods_production > 0
            }
        }
        if = {
            limit = {
                NOT = {
                    b:building_construction_regulator = {
                        has_active_production_method = pm_arc_welded_point_conversion
                    }
                }
            }
            activate_production_method = {
                building_type = building_construction_regulator
                production_method = pm_arc_welded_point_conversion
            }
        }
    }
    #cases when there is no production yet
    else_if = {
        limit = {
            owner = {
                has_technology_researched = arc_welding
            }
        }
        if = {
            limit = {
                NOT = {
                    b:building_construction_regulator = {
                        has_active_production_method = pm_arc_welded_point_conversion
                    }
                }
            }
            activate_production_method = {
                building_type = building_construction_regulator
                production_method = pm_arc_welded_point_conversion
            }
        }
    }
    else_if = {
        limit = {
            owner = {
                has_technology_researched = steel_frame_buildings
            }
        }
        if = {
            limit = {
                NOT = {
                    b:building_construction_regulator = {
                        has_active_production_method = pm_steel_point_conversion
                    }
                }
            }
            activate_production_method = {
                building_type = building_construction_regulator
                production_method = pm_steel_point_conversion
            }
        }
    }
    else_if = {
        limit = {
            owner = {
                has_technology_researched = urban_planning
            }
        }
        if = {
            limit = {
                NOT = {
                    b:building_construction_regulator = {
                        has_active_production_method = pm_iron_point_conversion
                    }
                }
            }
            activate_production_method = {
                building_type = building_construction_regulator
                production_method = pm_iron_point_conversion
            }
        }
    }
    else = {
        if = {
            limit = {
                NOT = {
                    b:building_construction_regulator = {
                        has_active_production_method = pm_wood_point_conversion
                    }
                }
            }
            activate_production_method = {
                building_type = building_construction_regulator
                production_method = pm_wood_point_conversion
            }
        }
    }
}

#Scope: Country
set_construction_point_demand = {
    if = {
        limit = { 
            has_technology_researched = urbanization
        }
        if = {
            limit = {
                has_modifier = country_private_construction_allocation_add
            }
            remove_modifier = country_private_construction_allocation_add
        }
        else = {
            set_variable = {
                name = prev_construction_allocation
                value = 0
            }
        }
        
        if = {
            limit = {
                NOT = {
                    has_variable = prev_estimated_investment_pool
                }
            }
            set_variable = {
                name = prev_estimated_investment_pool
                value = 0
            }
        }
        
        if = {
            limit = {
                has_variable = privatisation_percent_estimate
            }
            set_variable = {
                name = privatisation_percent_estimate
                value = privatisation_spending_percent
            }
        }
        else = {
            set_variable = {
                name = privatisation_percent_estimate
                value = 0
            }
        }
        set_variable = {
            name = national_production
            value = national_construction_production
        }
        set_variable = {
            name = total_construction_spending
            value = calculate_total_construction_spending
        }
        if = {
            limit = {
                has_variable = construction_price_estimate
            }
            set_variable = {
                name = construction_price_estimate
                value = construction_price_average
            }
        }
        else = {
            set_variable = {
                name = construction_price_estimate
                value = construction_good_adjustable_base_price
            }
        }

        check_construction_spending_level = {}

        set_local_variable = {
            name = current_construction_increase
            value = private_construction_increase
        }

        add_modifier = {
            name = country_private_construction_allocation_add
            multiplier = {
                value = local_var:current_construction_increase
            }
        }

        set_variable = {
            name = prev_construction_allocation
            value = local_var:current_construction_increase
        }

        set_variable = {
            name = limited_government_construction_spending
            value = calculate_limited_government_construction_spending
        }
        set_variable = {
            name = nominal_construction_demand
            value = calculate_nominal_construction
        }
        set_variable = {
            name = limited_construction_demand
            value = calculate_limited_construction_demand
        }
        set_local_variable = {
            name = remaining_construction_demand
            value = var:limited_construction_demand
        }
        ordered_scope_state = {
            order_by = construction_ordering
            min = 0
            set_local_variable = {
                name = state_construction
                value = state_construction_allocation
            }
            
            change_local_variable = {
                name = remaining_construction_demand
                subtract = local_var:state_construction
            }
            set_construction_regulator_level = yes
            set_state_construction_efficiency = yes
            b:building_construction_regulator = {
                if = {
                    limit = {
                        has_modifier = construction_throughput_mult
                    }
                    remove_modifier = construction_throughput_mult
                }
                set_local_variable = {
                    name = modifier_mult
                    value = {
                        value = local_var:state_construction
                        divide = {
                            value = level
                            min = 1
                        }
                        subtract = 1
                    }
                }
                add_modifier = {
                    name = construction_throughput_mult
                    multiplier = local_var:modifier_mult
                }
            }
            change_point_converter_production_method = yes
        }
        set_variable = {
            name = government_construction_spending
            value = calculate_government_construction_spending
        }
        set_variable = {
            name = prev_estimated_investment_pool
            value = {
                value = investment_pool
                add = investment_pool_net_income
                min = 0
            }
        }
    }
}

#Scope: State
set_construction_regulator_level = {
    set_local_variable = {
        name = regulator_level
        value = construction_regulator_level
    }
    if = {
        limit = {
            state_has_building_type_levels = {
                target = bt:building_construction_regulator
                value > local_var:regulator_level
            }
        }
        remove_building = "building_construction_regulator"
    }
    if = {
        limit = {
            state_has_building_type_levels = {
                target = bt:building_construction_regulator
                value < local_var:regulator_level
            }
        }
        massive_building_switch = {
            type = building_construction_regulator
            level = local_var:regulator_level
        }
    }
}

#Scope: State
set_state_construction_efficiency = {
    if = {
        limit = {
            has_building = building_construction_sector
        }
        if = {
            limit = {
                has_modifier = state_construction_efficiency_increase
            }
            remove_modifier = state_construction_efficiency_increase
        }
        set_local_variable = {
            name = efficiency_val
            value = calculate_state_construction_efficiency
        }
        add_modifier = {
            name = state_construction_efficiency_increase
            multiplier = local_var:efficiency_val
        }
    }
}